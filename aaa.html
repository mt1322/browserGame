<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        #start {
            position: absolute;
            left: 200px;
            top: 200px;
        }

    </style>
    <script>
    "use strict"
    
    var ctx;
    var player;
    var keyCode=[0, 0, 0];
    var mainTimer = NaN, jumpTimer = NaN, fallTimer = NaN;
    var jumpHeight = 353, fallHeight = 355;
    var check = false;
    var dec = false;
    var fallPoint;
    var holes = [];
    var enemys = [];
    var whileJump = false, whileFall = false, whileMove = false;
    var jumpCount = 0;
    var fallCount = 0;
    var enemyCount = [];
    var holeInterval = 0;
    var enemyInterval = 0;
    var moveX = 0;
    var background = 0;
    var background2 = 2500;
    var enemyUp = [];

    function init() { //初期設定
        var stage = document.getElementById("stage");
        ctx = stage.getContext("2d");
        ctx.font = "bold 48px sans-serif";
        paintBackground();

        player = new Player(100,355);
        
        player.paint(100, 355, 50, 50);
        var enemy = document.getElementById("enemy");
        var enemy2 = document.getElementById("enemy2");
        var grass = document.getElementById("grass");
        var hole = document.getElementById("hole");
    }

    function Player(x, y) {
        this.x = x;
        this.y = y;

        this.getX = function() {
            return this.x;
        }

        this.getY = function() {
            return this.y;
        }

        this.setX = function(x) {
            this.x = x;
        }

        this.setY = function(y) {
            this.y = y;
        }

        this.paint = function(x, y, w, h) {
            var img = document.getElementById("player");
            ctx.drawImage(img, x, y, w, h);          
        }

    }

    function go() { //スタートボタン押下時
        window.onkeydown = mykeydown;
        window.onkeyup = mykeyup;
        
        mainTimer = setInterval(tick, 7);
        document.getElementById("start").style.display = "none";
  
    }
    

    function tick() { //メインループ
            paintBackground();
            holes.forEach( function(value, index) {
            holes[index]--;
            paintHole(value);
            if(value <= -200){ //画面外にある場合リセット
                holes.shift();
            }
            if((player.getX()+30 > value && player.getX()+30 < (value+100)) && player.getY() == 355 && !whileJump && !whileFall){ //穴の落下判定
                whileFall = true;
                clearInterval(fallTimer);
                clearInterval(mainTimer);
                mainTimer = setInterval(tick, 7);
                fallTimer = setInterval(fall, 7);
                fallPoint = index;
            }
        });

        enemys.forEach( function(value, index) {
            switch(value.enemyId){
                case 0:
                    if(enemyCount[index] < 150){
                        enemys[index].enemyPointX -= 2;
                    }
                    else{
                        enemys[index].enemyPointX += 0.1;
                    }
                    break;
                case 1:
                    if(value.enemyPointY <= 200) enemyUp[index] = false;
                    else if(value.enemyPointY >= 355) enemyUp[index] = true;
                    if(enemyUp[index]){
                        enemys[index].enemyPointY--;
                    }
                    else{
                        enemys[index].enemyPointY++;
                    }
                    enemys[index].enemyPointX--;
                    break;
            }
            paintEnemy(value.enemyId, value.enemyPointX, value.enemyPointY);
            if(value.enemyPointX <= -200){ //画面外にいる場合リセット
                switch(value.enemyId){
                    case 0:
                        enemys.shift();
                        enemyCount.shift();
                        break;
                    case 1:
                        enemys.shift();        
                        enemyUp.shift();
                        break;
                }
            }
            if((player.getX()+30 > value.enemyPointX) && (player.getX()-30 < value.enemyPointX) && 
               (325 < value.enemyPointY) && !whileJump){ //ジャンプしていないときに敵に接触
                clearInterval(mainTimer);
                ctx.fillText("GAME OVER", 200, 200);
            }
            else if((player.getX()+30 > value.enemyPointX) && (player.getX()-30 < value.enemyPointX) && 
                    (player.getY()+30 > value.enemyPointY) && (player.getY()-30 < value.enemyPointY) && whileJump){ //敵の上に着地
                player.paint(player.getX(), player.getY(), 50, 50);
                clearInterval(mainTimer);
                clearInterval(jumpTimer);
                ctx.fillText("GAME OVER", 200, 200);
            }
        });

        enemyCount.forEach( function(value, index) {
            enemyCount[index]++;
            if(enemyCount[index] >= 300){
                enemyCount[index] = 0;
            }
        });


        keyCode.forEach( function(value) {
        switch(value){
            case 37:
                if(!whileFall){
                    moveX = player.getX();
                    player.setX(moveX -= 2);
                }
                break;
            case 39:
                if(!whileFall){
                    moveX = player.getX();
                    player.setX(moveX += 2);
                }
                break;
            case 90: //Zキー押下
                player.paint(player.getX(), 355, 50, 50);
                clearInterval(jumpTimer);
                clearInterval(mainTimer);
                mainTimer = setInterval(tick, 7);
                jumpTimer = setInterval(jump, 7);
                whileJump = true;
                break;   
        }
        });
        if(isNaN(jumpTimer) && !whileFall){ //ジャンプ,落下していない場合常にプレイヤー描写
            player.paint(player.getX(), 355, 50, 50);
        }

        if(random(500) == 0 && (enemyInterval >= 300 || enemyInterval == 0) && holeInterval == 0){ //穴ランダム生成
            paintHole(1250);
            holes.push(1250);
            holeInterval++;
        }

        if(random(100) == 0 && (holeInterval >= 300 || holeInterval == 0) && enemyInterval == 0){ //敵ランダム生成
            switch(random(2)){
                case 0:
                    paintEnemy(enemy, 1250);
                    enemys.push({enemyId:0, enemyPointX:1250, enemyPointY:355});
                    break;
                case 1:
                    paintEnemy(enemy2, 1250);
                    enemys.push({enemyId:1, enemyPointX:1250, enemyPointY:355});
                    enemyUp.push(false);
                    break;
                defaurt:
                    break;
            }
            enemyCount.push(0);
            enemyInterval++;
        }

        if(holeInterval >= 1){ //次の穴との時間間隔
            holeInterval++;
            if(holeInterval == 500){
                holeInterval = 0;
            }
        }
        if(enemyInterval >= 1){ //次の敵との時間間隔
            enemyInterval++;
            if(enemyInterval == 500){
                enemyInterval = 0;
            }
        }
        
    }

    function jump() { //ジャンプ動作
        player.setY(jumpHeight);
        if(jumpHeight==355){ //着地時
            clearInterval(jumpTimer);
            jumpTimer = NaN;
            dec = false;
            whileJump = false;
            jumpHeight -= 2;
            jumpCount = 0;
        }
        else if(dec){
            if(jumpCount == 20){ //下降
                jumpHeight += 2;
            }
            else{ //ジャンプ頂点まで減速
                jumpCount++;
                jumpHeight--;
            }
        }
        else { //上昇
            jumpHeight -= 2;
        }
                
        if(jumpHeight == 241){ //ジャンプ頂点前判定
            dec = true;
        }
        
        player.paint(player.getX(), jumpHeight, 50, 50);
      
    }

    function fall() { //落下動作
        fallHeight++;
        holes.forEach( function(value) {
            paintHole(value);
            if(player.getX() + 50 >= (holes[fallPoint]+100)){ //穴の右端に接触時プレイヤーを移動
                player.paint(holes[fallPoint]+55, fallHeight, 50, 50);
            }
            else{
                player.paint(player.getX(), fallHeight, 50, 50);
            }
        });
        fallCount++;
        if(fallCount >= 200){ //完全に落下するまで時間を置く
            clearInterval(mainTimer);
            clearInterval(fallTimer);
            ctx.fillText("GAME OVER", 200, 200);
        }

    }

    function paintHole(x) {
        var holePoint = x;
        ctx.drawImage(hole, holePoint, 400, 100, 100);
    }

    function paintEnemy(id, x, y) {
        switch(id){
            case 0:
                ctx.drawImage(enemy, x, y, 50, 50);
                break;
            case 1:
                ctx.drawImage(enemy2, x, y, 50, 50);
                break;
            }
    }

    function paintBackground() {
        background -= 1;
        background2 -= 1;
        if(background <= -2500){
            background = 2500;
        }
        else if(background2 <= -2500){
            background2 = 2500;
        }
        ctx.drawImage(grass, background, 0, 2500, 500);
        ctx.drawImage(grass, background2, 0, 2500, 500);
    }

    function random(v) {
        return Math.floor(Math.random() * v);
    }

    function mykeydown(e) {
        if(!whileFall){ //ジャンプ,落下していない場合
            if(e.keyCode == 37){
                keyCode[0] = 37;
            }
            else if(e.keyCode == 39){
                keyCode[1] = 39;
            }
            else if(!whileJump){
                keyCode[2] = 90;
            }
        }
    }
    function mykeyup(e) {
        if(e.keyCode == 37){
            keyCode[0] = 0;
        }
        else if(e.keyCode == 39){
            keyCode[1] = 0;
        }
        else{
            keyCode[2] = 0;
        }
    }

    </script>
</head>
<body onload="init()">
    <canvas id="stage" width="1250" height="500"></canvas>
    <img id="start" src="start.png" onclick="go()"><br/>
    <img id="player" src="hero3.png" style="display:none" />
    <img id="enemy" src="enemy.gif" style="display:none" />
    <img id="enemy2" src="enemy2.gif" style="display:none" />
    <img id="grass" src="sougen.png" style="display:none" />

    <img id="hole" src="hole.png" style="display:none" />
    
</body>
</html>